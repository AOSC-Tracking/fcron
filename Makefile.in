############################
# fcron's Makefile  ########
############################

# @configure_input@

# $Id: Makefile.in,v 1.56 2001-02-01 20:51:03 thib Exp $

# The following should not be edited manually (use configure options)
# If you must do it, BEWARE : some of the following is also defined
# in config.h, so you must modify config.h AND Makefile in order
# to set the same values in the two files.


# Where should we install it ?
prefix		= @prefix@
exec_prefix	= @exec_prefix@
DESTSBIN	= @sbindir@
DESTBIN		= @bindir@
DESTMAN		= @mandir@
DESTDOC		= @DOCDIR@
FCRONTABS	= @FCRONTABS@
ETC		= @ETC@
CFLAGS		= @CFLAGS@
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@
LIBOBJS		= @LIBOBJS@
DEFS		= @DEFS@ 
CC		= @CC@
INSTALL		= @INSTALL@
ROOTNAME	= @ROOTNAME@
ROOTGROUP	= @ROOTGROUP@
USERNAME 	= @USERNAME@
GROUPNAME	= @GROUPNAME@
DEBUG		= @DEBUG@
ANSWERALL	= @ANSWERALL@

# Optimize or debug ?
#	-DDEBUG		even more verbose
#	-DCHECKJOBS     send a mail containing the exact shell command
#			for each execution of each job.
OPTIM = @CFLAGS@
#OPTIM=	-DDEBUG -g -DFOREGROUND -DMALLOC_CHECK_=2
#OPTIM=	-DDEBUG -g -DCHECKJOBS -Wall -Wpointer-arith -Wstrict-prototypes
#OPTIM=	-DDEBUG -Wall -Wpointer-arith -Wstrict-prototypes
#OPTIM=	-O2 -Wall
#OPTIM=	-O3 -mcpu=i686 -Wall


# Options
#	-DFOREGROUND=[0|1]    default run in foreground ?
OPTION = 


####################################
# Should not be changed under this #
####################################

VERSION= @VERSION@
CFLAGS= $(INCLUDE) $(OPTIM) $(OPTION) $(DEFS)
OBJSD = fcron.o subs.o database.o job.o log.o conf.o $(LIBOBJS)
OBJS= fcrontab.o fileconf.o subs.o log.o allow.o
HEADERSD = fcron.h config.h global.h option.h getloadavg.h
HEADERS = fcrontab.h config.h global.h option.h

# this is two regular expressions
RCSNOLOG=.*\(.html\|VERSION\|MANIFEST\|configure\|install.sh\)
REXP_MANPAGES=.*[158]

all: fcron fcrontab

fcron: $(OBJSD) $(HEADERSD)
	$(CC) $(CFLAGS) $(LIBS) -o $@ $(OBJSD)

fcrontab: $(OBJS) $(HEADERS)
	$(CC) $(CFLAGS) $(LIBS) -o $@ $(OBJS)

fcrontab.o: fcrontab.c $(HEADERS)
	$(CC) $(CFLAGS) -c fcrontab.c 

fileconf.o:  fileconf.c $(HEADERS)
	$(CC) $(CFLAGS) -c fileconf.c 

allow.o:  allow.c $(HEADERS)
	$(CC) $(CFLAGS) -c allow.c 

%.o: %.c $(HEADERSD)
	$(CC) $(CFLAGS) -c $<

install: all

	script/user-group $(USERNAME) $(GROUPNAME) $(ANSWERALL)

	if test ! -d $(DESTSBIN); then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTSBIN) ; fi
	if test ! -d $(DESTBIN); then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTBIN) ; fi
	if test ! -d $(ETC); then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(ETC) ; fi
	if test ! -d $(DESTMAN)/man1; then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTMAN)/man1 ; fi
	if test ! -d $(DESTMAN)/man3; then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTMAN)/man3 ; fi
	if test ! -d $(DESTMAN)/man5; then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTMAN)/man5 ; fi
	if test ! -d $(DESTMAN)/man8; then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTMAN)/man8 ; fi
	if test ! -d $(DESTDOC)/fcron-$(VERSION); then $(INSTALL) -g $(ROOTGROUP) -o $(ROOTNAME) -m 755 -d $(DESTDOC)/fcron-$(VERSION) ; fi
	$(INSTALL) -g $(GROUPNAME) -o $(USERNAME) -m 770 -d $(FCRONTABS)

	$(INSTALL) -g $(GROUPNAME) -o $(USERNAME) -m 110 -s fcron $(DESTSBIN)
	$(INSTALL) -g $(GROUPNAME) -o $(USERNAME) -m 6111 -s fcrontab $(DESTBIN)
	test -f $(ETC)/fcron.allow || test -f $(ETC)/fcron.deny || $(INSTALL) -m 640 -o $(ROOTNAME) -g $(GROUPNAME) files/fcron.allow files/fcron.deny $(ETC)
	$(INSTALL) -m 644 -o $(ROOTNAME) doc/fcron.8 $(DESTMAN)/man8
	$(INSTALL) -m 644 -o $(ROOTNAME) doc/fcrontab.1 $(DESTMAN)/man1
	$(INSTALL) -m 644 -o $(ROOTNAME) doc/fcrontab.5 $(DESTMAN)/man5
	$(INSTALL) -m 644 -o $(ROOTNAME) doc/bitstring.3 $(DESTMAN)/man3
	cd doc; $(INSTALL) -m 644 -o $(ROOTNAME) README LICENSE CHANGES *.html \
		 $(DESTDOC)/fcron-$(VERSION)/

# in order to get correct rights when upgrading :
	find $(FCRONTABS) -type f \( -name "*.orig" -a ! -name "root.orig" \) -exec chown $(USERNAME):$(GROUPNAME) {} \; -exec chmod 640 {} \;
	if test -f $(ETC)/fcron.deny; then chown $(ROOTNAME):$(GROUPNAME) $(ETC)/fcron.deny ; fi
	if test -f $(ETC)/fcron.allow; then chown $(ROOTNAME):$(GROUPNAME) $(ETC)/fcron.allow ; fi

	script/sysVinit-install "$(INSTALL) -o $(ROOTNAME)" $(DESTSBIN) $(DEBUG) $(FCRONTABS)  $(ANSWERALL)

install-boot: install
	if test "$(DEBUG)" = "1"; then \
	  script/sysVinit-install "$(INSTALL) -o $(ROOTNAME)" $(DESTSBIN) 0 $(FCRONTABS)  $(ANSWERALL);\
	fi

install-restart: install
	if test "$(DEBUG)" = "1"; then \
	  kill -TERM `pidof fcron` ; \
	  /etc/rc.d/init.d/fcron start ;\
	fi

uninstall:
	rm -f $(DESTSBIN)/fcron
	rm -f $(DESTBIN)/fcrontab
	rm -fR $(DESTDOC)/fcron-$(VERSION)
	rm -f $(DESTMAN)/man1/fcrontab.1
	rm -f $(DESTMAN)/man3/bitstring.3
	rm -f $(DESTMAN)/man5/fcrontab.5
	rm -f $(DESTMAN)/man8/fcron.8
	script/sysVinit-uninstall

clean:
	rm -f *.o
	rm -f fcron fcrontab

vclean: clean
	find ./ -name "*~" -exec rm -f {} \;
	rm -f config.log config.status config.h config.cache Makefile


%.html: %.in Makefile config.h
	script/gen-manpage.pl $*.in $*
	groff -Thtml -mandoc $* > ./tmp
	sed "s:<body.*>:<body BGCOLOR="\#000000" TEXT="\#FFFFFF" \
		LINK="\#0FA0FF" VLINK="\#B000B0" ALINK="\#FF0000"> \
		<i>Generated by groff</i><br><h1>$(*F)</h1><br>:I" < ./tmp > $@
	rm -f ./tmp

updatedoc: doc/*
	script/gen-doc $(VERSION)

configure: configure.in
	autoconf

tar: updatedoc configure vclean

	echo $(VERSION) > ./VERSION

	@(find ./ -type f ! -regex '.*RCS.*' ! -regex "$(RCSNOLOG)" \
             ! -regex "$(REXP_MANPAGES)" -exec ci -l {} \;)

	@(find ./ -type f ! -regex '.*RCS.*' | \
             sed -e "s:^\./:fcron-$(VERSION)/:" > MANIFEST)
	@(cd ..; ln -s fcron fcron-$(VERSION))
	(cd ..; tar -czvf fcron-$(VERSION).src.tar.gz `cat fcron/MANIFEST`)
	@(cd ..; rm -f fcron-$(VERSION))

	@(cd ..; mv -f fcron-$(VERSION).src.tar.gz old-fcron-pkg/)






